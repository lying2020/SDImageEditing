# 参数详细说明

## 📋 train_json.sh 参数详解

### 🔧 基本运行参数

#### `torchrun --nnodes=1 --nproc_per_node=2`
- **`--nnodes=1`**: 使用的节点（机器）数量，1 表示单机运行
- **`--nproc_per_node=2`**: 每个节点使用的 GPU 数量，2 表示使用 2 块 GPU（分布式训练）
  - 如果只有 1 块 GPU，改为 `--nproc_per_node=1`

---

### 📁 文件路径参数

#### `--image_dir_path ../images/`
- **含义**: 输入图片所在的目录路径
- **说明**: 批量处理时，指定包含所有图片的文件夹
- **示例**: `../images/` 表示上级目录的 images 文件夹

#### `--output_dir ../output/`
- **含义**: 输出结果的保存目录
- **说明**: 编辑后的图片会保存在这个目录
- **包含内容**:
  - 编辑后的图片
  - 如果使用 `--draw_box`，还会保存带边界框的可视化图片

#### `--json_file ../images.json`
- **含义**: JSON 配置文件的路径
- **说明**: 批量处理时，这个文件定义了每张图片的原始描述和编辑提示
- **格式示例**:
  ```json
  {
    "1.png": ["trees", "a big tree with many flowers in the center"],
    "2.png": ["coffee", "soft drink"]
  }
  ```

#### `--save_path ../checkpoints/`
- **含义**: 模型检查点（checkpoint）的保存路径
- **说明**: 训练过程中会保存模型权重，用于后续加载继续训练

---

### 🎨 模型相关参数

#### `--diffusion_model_path 'stabilityai/stable-diffusion-2-inpainting'`
- **含义**: 使用的扩散模型路径
- **说明**:
  - 可以是 HuggingFace 模型 ID（如示例），会自动下载
  - 也可以是本地模型路径
- **推荐**:
  - `stabilityai/stable-diffusion-2-inpainting`（推荐，更稳定）
  - `runwayml/stable-diffusion-inpainting`（原论文使用，但已被移除）

#### `--draw_box`
- **含义**: 是否绘制边界框
- **说明**:
  - 添加此参数：会在输出图片上绘制编辑区域的边界框（可视化用）
  - 不添加：只输出编辑后的图片
- **输出位置**: 保存在 `output_dir/boxes/` 目录

---

### 🎯 训练核心参数

#### `--lr 5e-3`
- **含义**: 学习率（Learning Rate）
- **说明**: 控制模型参数更新的步长
- **默认值**: `1e-2` (0.01)
- **调参建议**:
  - 值太大：训练不稳定，可能发散
  - 值太小：训练慢，收敛慢
  - `5e-3` (0.005) 是一个比较温和的值

#### `--max_window_size 15`
- **含义**: 最大边界框（bounding box）尺寸
- **说明**: 控制编辑区域的最大范围（以像素为单位）
- **默认值**: `6`
- **调参建议**:
  - 增大：可以编辑更大的区域，但计算量增加
  - 减小：编辑区域更小，速度更快
  - `15` 适合编辑中等大小的对象

#### `--per_image_iteration 10`
- **含义**: 每张图片的训练迭代次数
- **说明**: 控制对每张图片进行多少次优化迭代
- **默认值**: `1`
- **调参建议**:
  - 增大：编辑质量更好，但时间更长
  - 减小：速度快，但可能效果不够好
  - `10` 是质量和速度的平衡点

#### `--epochs 1`
- **含义**: 训练轮数（epochs）
- **说明**: 整个数据集训练多少轮
- **默认值**: `10`
- **注意**: 对于图像编辑任务，通常 1 个 epoch 就足够了

---

### 🔍 采样相关参数

#### `--point_number 9`
- **含义**: 采样锚点数量
- **说明**: 用于定位编辑区域的采样点数量
- **默认值**: `3`
- **调参建议**:
  - 增大：更精确地定位编辑区域，但计算量增加
  - 减小：速度快，但可能定位不够准确
  - `9` 提供较好的精度和速度平衡

---

### ⚙️ 系统性能参数

#### `--num_workers 8`
- **含义**: 数据加载的进程数
- **说明**: 用于并行加载数据，提高效率
- **默认值**: `16`
- **调参建议**:
  - 根据 CPU 核心数调整
  - 8 核 CPU 建议设置为 4-8
  - 过多可能导致内存占用高

#### `--batch_size 1`
- **含义**: 批次大小
- **说明**: 每次处理多少张图片
- **默认值**: `192`（但图像编辑通常用 1）
- **调参建议**:
  - GPU 显存小：设置为 1
  - GPU 显存大（>16GB）：可以尝试 2-4
  - 注意：图像编辑任务通常 batch_size=1 效果最好

#### `--pin_mem`
- **含义**: 固定内存（Pin Memory）
- **说明**: 将数据固定在内存中，加快 GPU 传输速度
- **效果**: 可以提升 10-20% 的数据加载速度
- **注意**: 需要更多内存，如果内存不足可以去掉此参数

---

### 🎲 随机种子参数

#### `--seed 42`
- **含义**: 随机种子
- **说明**: 控制随机数生成，确保结果可复现
- **效果**:
  - 相同种子 + 相同参数 = 相同结果
  - 不同种子可能产生不同的编辑结果
- **建议**: 调试时可以固定，实验时可以尝试不同值

---

## 📊 参数分类总结

### 🎯 影响编辑效果的关键参数
1. **`--max_window_size`**: 控制编辑区域大小
2. **`--per_image_iteration`**: 控制编辑质量
3. **`--point_number`**: 控制定位精度
4. **`--lr`**: 控制学习速度

### ⚡ 影响运行速度的参数
1. **`--per_image_iteration`**: 迭代次数越多，时间越长
2. **`--point_number`**: 采样点越多，计算越多
3. **`--max_window_size`**: 窗口越大，计算越多
4. **`--nproc_per_node`**: GPU 数量影响并行速度
5. **`--num_workers`**: 数据加载速度

### 💾 影响显存/内存的参数
1. **`--batch_size`**: 批次越大，显存占用越多
2. **`--max_window_size`**: 窗口越大，显存占用越多
3. **`--pin_mem`**: 会占用更多内存

## 🔧 常见调参场景

### 场景1: 显存不足（OOM）
```bash
--batch_size 1          # 减小批次
--max_window_size 10    # 减小窗口大小
--point_number 5        # 减少采样点
# 去掉 --pin_mem
```

### 场景2: 编辑效果不理想
```bash
--per_image_iteration 20   # 增加迭代次数
--point_number 12         # 增加采样点
--max_window_size 20      # 增大编辑区域
--lr 3e-3                 # 稍微降低学习率
```

### 场景3: 需要快速测试
```bash
--per_image_iteration 5   # 减少迭代次数
--point_number 5          # 减少采样点
--max_window_size 10      # 减小窗口
--epochs 1                # 只训练1轮
```

### 场景4: 只有1块GPU
```bash
torchrun --nnodes=1 --nproc_per_node=1 train.py  # 改为1
```

## 💡 参数推荐配置

### 快速测试（约2分钟/张）
```bash
--per_image_iteration 5
--max_window_size 10
--point_number 5
--batch_size 1
```

### 标准配置（约4分钟/张，推荐）
```bash
--per_image_iteration 10
--max_window_size 15
--point_number 9
--batch_size 1
```

### 高质量配置（约8分钟/张）
```bash
--per_image_iteration 20
--max_window_size 20
--point_number 12
--batch_size 1
```
